{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
    <h2>Dashboard</h2>

    <!-- Summary Section -->
    <article>
    <h3>Summary</h3>
    <div class="grid">
        <div>Income: <strong style="color: green;">{{ summary.total_income | round(2) }}</strong></div>
        <div>Expenses: <strong style="color: red;">{{ summary.total_expense | round(2) }}</strong></div>
        <div>Balance: <strong>{{ summary.balance | round(2) }}</strong></div>
    </div>
    </article>

    <!-- Add Transaction Forms -->
    <section>
        <h3>Add New Transaction</h3>
        <form method="POST" action="{{ url_for('add_transaction') }}">
            <label>Type *</label>
            <input type="radio" id="type_income" name="type" value="income" checked>
            <label for="type_income">Income</label>
            <input type="radio" id="type_expense" name="type" value="expense">
            <label for="type_expense">Expense</label>

            <label for="amount">Amount *</label>
            <input type="number" step="0.01" min="0.01" id="amount" name="amount" required>

            <div id="category_field">
                <label id="category_label" for="category">Category *</label>
                <input list="income_categories" id="category" name="category" placeholder="e.g., Salary">
                <datalist id="income_categories">
                    <option value="Salary">
                    <option value="Bonus">
                    <option value="Other">
                </datalist>
                <datalist id="expense_categories">
                    {% for cat in categories %}
                        <option value="{{ cat }}">
                    {% endfor %}
                    <option value="Food">
                    <option value="Utilities">
                    <option value="Transport">
                    <option value="Entertainment">
                    <option value="Shopping">
                    <option value="Health">
                    <option value="Other">
                </datalist>
            </div>

            <label for="description">Description</label>
            <input type="text" id="description" name="description">

            <label for="date">Date (YYYY-MM-DD)</label>
            <input type="date" id="date" name="date">

            <button type="submit">Add Transaction</button>
        </form>
    </section>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        function updateCategoryField() {
            var isIncome = document.getElementById('type_income').checked;
            var categoryInput = document.getElementById('category');
            var label = document.getElementById('category_label');
            if (isIncome) {
                categoryInput.setAttribute('list', 'income_categories');
                categoryInput.placeholder = 'e.g., Salary';
                label.textContent = 'Category * (Income)';
            } else {
                categoryInput.setAttribute('list', 'expense_categories');
                categoryInput.placeholder = 'e.g., Groceries';
                label.textContent = 'Category * (Expense)';
            }
        }
        document.getElementById('type_income').addEventListener('change', updateCategoryField);
        document.getElementById('type_expense').addEventListener('change', updateCategoryField);
        updateCategoryField(); // Set initial state
    });
    </script>

    <!-- Recommendations -->
    {% if recommendations %}
    <article>
        <h3>Recommendations</h3>
        <ul>
            {% for tip in recommendations %}
                <li>{{ tip }}</li>
            {% endfor %}
        </ul>
    </article>
    {% endif %}


<!-- Recent Transactions Table -->
<article>
    <h3>Recent Transactions (Last 20)</h3>
    {% if transactions %}
        <figure style="overflow-x: auto;"> <!-- Allow horizontal scroll if needed -->
        <table role="grid">
        <thead>
            <tr>
            <th scope="col">Date</th>
            <th scope="col">Type</th>
            <th scope="col">Amount</th>
            <th scope="col">Category</th>
            <th scope="col">Description</th>
            <!-- ADD ACTIONS HEADER -->
            <th scope="col" colspan="2" style="text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %} <!-- Assuming transactions is already sorted -->
            <tr>
                <td>{{ transaction.date | default('N/A') }}</td>
                <td>{{ transaction.type | capitalize }}</td>
                <td class="{{ transaction.type }}"> <!-- Apply income/expense class for color -->
                    {{ transaction.amount | round(2) }}
                </td>
                <td>{{ transaction.category | default('') }}</td>
                <td>{{ transaction.description | default('') }}</td>

                <!-- ADD EDIT Button/Link -->
                <td style="padding: 0.3rem 0.5rem; text-align: center; vertical-align: middle;">
                    <a href="{{ url_for('edit_transaction', transaction_id=transaction.transaction_id) }}" role="button" class="secondary outline" style="padding: 0.2rem 0.5rem; font-size: 0.8em; margin: 0;">Edit</a>
                </td>

                <!-- ADD DELETE Button (using a mini-form for POST) -->
                <td style="padding: 0.3rem 0.5rem; text-align: center; vertical-align: middle;">
                    <form action="{{ url_for('delete_transaction', transaction_id=transaction.transaction_id) }}" method="POST" style="margin-bottom: 0; display: inline;" onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                         <button type="submit" class="contrast outline" style="padding: 0.2rem 0.5rem; font-size: 0.8em; margin: 0;">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
        </figure>
    {% else %}
        <p>No transactions recorded yet.</p>
    {% endif %}
</article>

{% endblock %}