{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
    <h2 style="margin-bottom: 2rem;">Dashboard</h2>

    <!-- Mode Tabs -->
    <div id="mode-tabs" style="display: flex; gap: 1rem; margin-bottom: 0.5rem; align-items: center;">
        <button id="tab-all-time" class="tab-btn active" type="button" style="padding: 0.5rem 1.2rem; font-size: 1rem; border-radius: 6px; border: 1px solid #6366f1; background: #6366f1; color: #fff; font-weight: 500;">All Time</button>
        <button id="tab-monthly" class="tab-btn" type="button" style="padding: 0.5rem 1.2rem; font-size: 1rem; border-radius: 6px; border: 1px solid #6366f1; background: #fff; color: #6366f1; font-weight: 500;">Monthly</button>
    </div>
    <div id="month-year-controls" style="display: none; align-items: center; gap: 0.5rem; margin-bottom: 2rem;">
        <label for="month-select" style="font-weight: 500;">Month:</label>
        <select id="month-select" style="padding: 0.3rem 0.7rem; border-radius: 5px; border: 1px solid #d1d5db; font-size: 1rem;"></select>
        <label for="year-select" style="font-weight: 500;">Year:</label>
        <select id="year-select" style="padding: 0.3rem 0.7rem; border-radius: 5px; border: 1px solid #d1d5db; font-size: 1rem;"></select>
    </div>

    <!-- Summary Section -->
    <article id="summary-section" style="display: flex; gap: 2rem; justify-content: space-between; align-items: center; background: #f3f4f6; box-shadow: none;"></article>

    <!-- Charts Section -->
    <div id="main-chart-section" style="margin-bottom: 2rem;">
        <!-- Main chart and pie chart always side by side -->
        <div id="main-charts-row" style="display: flex; flex-wrap: wrap; gap: 2rem;">
            <article id="mainChartArticle" style="flex: 1 1 350px; min-width: 320px; min-height: 350px;">
                <h3 id="mainChartTitle" style="margin-bottom: 1rem;">Income vs Expenses</h3>
            <div style="height: 300px; position: relative;">
                    <canvas id="mainChart"></canvas>
            </div>
        </article>
            <article style="flex: 1 1 350px; min-width: 320px; min-height: 350px; background: #f9fafb; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h3 style="margin-bottom: 1rem;">Spending by Category</h3>
            <div style="height: 300px; position: relative;">
                    <canvas id="categoryChart"></canvas>
            </div>
        </article>
        </div>
    </div>
    
    <!-- Floating Action Button for Add Transaction -->
    <button id="fab-add-transaction" aria-label="Add Transaction" style="position: fixed; bottom: 2.5rem; right: 2.5rem; width: 64px; height: 64px; border-radius: 50%; background: #6366f1; color: #fff; border: none; box-shadow: 0 4px 16px rgba(99,102,241,0.25); display: flex; align-items: center; justify-content: center; z-index: 1001; cursor: pointer; transition: background 0.2s;">
      <span style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">&#43;</span>
    </button>

    <!-- Modal for Add Transaction -->
    <div id="add-transaction-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 1002; align-items: center; justify-content: center;">
      <div style="background: #fff; border-radius: 12px; max-width: 480px; width: 95vw; padding: 2rem 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; display: flex; flex-direction: column;">
        <button id="close-modal-btn" aria-label="Close" style="position: absolute; top: 1.2rem; right: 1.2rem; background: none; border: none; font-size: 2rem; color: #6366f1; cursor: pointer; align-self: flex-end;">&times;</button>
        <h3 style="margin-bottom: 1.2rem; text-align: center;">Add New Transaction</h3>
        <form id="add-transaction-form" method="POST" action="{{ url_for('add_transaction') }}">
        <div style="display: flex; flex-direction: column; gap: 0.7rem; align-items: flex-start; margin-bottom: 1.2rem;">
            <label style="margin-bottom: 0.3rem; font-weight: 500;">Type *</label>
            <div style="display: flex; gap: 1.5rem; align-items: center;">
                    <input type="radio" id="modal_type_income" name="type" value="income" checked style="margin-bottom: 0;">
                    <label for="modal_type_income" style="margin-bottom: 0; margin-right: 0.5rem;">Income</label>
                    <input type="radio" id="modal_type_expense" name="type" value="expense" style="margin-bottom: 0;">
                    <label for="modal_type_expense" style="margin-bottom: 0;">Expense</label>
                </div>
        </div>
        <div style="display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 1.2rem;">
            <div style="flex: 1 1 140px; min-width: 140px;">
                    <label for="modal_amount">Amount *</label>
                    <input type="number" step="0.01" min="0.01" id="modal_amount" name="amount" required>
            </div>
                <div style="flex: 1 1 180px; min-width: 180px;" id="modal_category_field">
                    <label id="modal_category_label" for="modal_category">Category *</label>
                    <input list="modal_income_categories" id="modal_category" name="category" placeholder="e.g., Salary">
                    <datalist id="modal_income_categories">
                    <option value="Salary">
                    <option value="Bonus">
                    <option value="Other">
                </datalist>
                    <datalist id="modal_expense_categories">
                    {% for cat in categories %}
                        <option value="{{ cat }}">
                    {% endfor %}
                    <option value="Food">
                    <option value="Utilities">
                    <option value="Transport">
                    <option value="Entertainment">
                    <option value="Shopping">
                    <option value="Health">
                    <option value="Other">
                </datalist>
            </div>
            <div style="flex: 2 1 220px; min-width: 220px;">
                    <label for="modal_description">Description</label>
                    <input type="text" id="modal_description" name="description">
            </div>
            <div style="flex: 1 1 180px; min-width: 180px;">
                    <label for="modal_date">Date</label>
                    <input type="date" id="modal_date" name="date">
                </div>
        </div>
        <button type="submit" style="margin-top: 0.2rem; width: 100%; height: 3rem;">Add Transaction</button>
    </form>
    </div>
</div>

<!-- Modal for Edit Transaction -->
<div id="edit-transaction-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.35); z-index: 1002; align-items: center; justify-content: center;">
  <div style="background: #fff; border-radius: 12px; max-width: 480px; width: 95vw; padding: 2rem 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative; display: flex; flex-direction: column;">
    <button id="close-edit-modal-btn" aria-label="Close" style="position: absolute; top: 1.2rem; right: 1.2rem; background: none; border: none; font-size: 2rem; color: #6366f1; cursor: pointer; align-self: flex-end;">&times;</button>
    <h3 style="margin-bottom: 1.2rem; text-align: center;">Edit Transaction</h3>
    <form id="edit-transaction-form" method="POST">
      <!-- Populated dynamically -->
    </form>
  </div>
</div>

<!-- Recommendations -->
{% if recommendations %}
<article style="background: #f3f4f6; border: 4px solid #6366f1; box-shadow: none;">
    <h3 style="margin-bottom: 0.5rem;">Recommendations</h3>
    <ul style="margin: 0; padding-left: 1.2em; line-height: 1.5;">
        {% for tip in recommendations %}
            <li>{{ tip }}</li>
        {% endfor %}
    </ul>
</article>
{% endif %}

<!-- Recent Transactions Table -->
<article>
    <h3 style="margin-bottom: 1rem;">All Transactions</h3>
    {% if transactions %}
        <figure style="margin: 0; background: none; box-shadow: none; max-height: 400px; overflow-y: auto;">
        <table role="grid">
        <thead>
            <tr>
            <th scope="col">Date</th>
            <th scope="col">Type</th>
            <th scope="col">Amount</th>
            <th scope="col">Category</th>
            <th scope="col">Description</th>
            <th scope="col" colspan="2" style="text-align: center;">Actions</th>
            </tr>
        </thead>
        <tbody id="transactions-table-body">
            {% for transaction in transactions %}
            <tr>
                <td>{{ transaction.date | default('N/A') }}</td>
                <td>{{ transaction.type | capitalize }}</td>
                <td class="{{ transaction.type }}">{{ transaction.amount | round(2) }}</td>
                <td>{{ transaction.category | default('') }}</td>
                <td>{{ transaction.description | default('') }}</td>
                <td style="padding: 0.3rem 0.5rem; text-align: center; vertical-align: middle;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                        <button class="edit-transaction-btn" data-id="{{ transaction.transaction_id }}" style="padding: 0.2rem 1.2rem; font-size: 0.9em; min-width: 80px;">Edit</button>
                        <form action="{{ url_for('delete_transaction', transaction_id=transaction.transaction_id) }}" method="POST" style="margin: 0; box-shadow: none; display: inline;">
                            <button type="submit" class="secondary outline" style="padding: 0.2rem 1.2rem; font-size: 0.9em; min-width: 80px; margin: 0;">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        </table>
        </figure>
    {% else %}
        <p>No transactions recorded yet.</p>
    {% endif %}
</article>

<!-- Charts JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    let mode = 'all_time';
    let selectedMonth = null;
    let selectedYear = null;
    const tabAllTime = document.getElementById('tab-all-time');
    const tabMonthly = document.getElementById('tab-monthly');
    const monthSelect = document.getElementById('month-select');
    const yearSelect = document.getElementById('year-select');
    const monthYearControls = document.getElementById('month-year-controls');
    function setActiveTab(selected) {
        tabAllTime.classList.toggle('active', selected === 'all_time');
        tabMonthly.classList.toggle('active', selected === 'month');
        tabAllTime.style.background = selected === 'all_time' ? '#6366f1' : '#fff';
        tabAllTime.style.color = selected === 'all_time' ? '#fff' : '#6366f1';
        tabMonthly.style.background = selected === 'month' ? '#6366f1' : '#fff';
        tabMonthly.style.color = selected === 'month' ? '#fff' : '#6366f1';
        monthYearControls.style.display = selected === 'month' ? 'flex' : 'none';
    }
    tabAllTime.addEventListener('click', function() {
        mode = 'all_time';
        setActiveTab(mode);
        reloadDashboardData();
    });
    tabMonthly.addEventListener('click', function() {
        mode = 'month';
        setActiveTab(mode);
        reloadDashboardData();
    });
    monthSelect.addEventListener('change', function() {
        selectedMonth = monthSelect.value;
        if (mode === 'month') reloadDashboardData();
    });
    yearSelect.addEventListener('change', function() {
        selectedYear = yearSelect.value;
        if (mode === 'month') reloadDashboardData();
    });
    function reloadDashboardData() {
        let params = '';
        if (mode === 'month' && selectedMonth && selectedYear) {
            params = `&mode=month&month=${selectedMonth}&year=${selectedYear}`;
        } else {
            params = '&mode=all_time';
        }
        // Main chart and pie chart always side by side
        const mainChart = document.getElementById('mainChart');
        const mainChartTitle = document.getElementById('mainChartTitle');
        if (window.mainChartInstance) window.mainChartInstance.destroy();
        if (window.categoryChartInstance) window.categoryChartInstance.destroy();
        if (mode === 'month') {
            mainChartTitle.textContent = 'Income vs Expenses';
            // Day-by-day income vs expenses (bar for expenses, line for income)
            fetch(`/get_chart_data?type=income_vs_expense${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.labels && data.labels.length > 0) {
                        if (data.datasets && data.datasets.length === 2) {
                            data.datasets[0].type = 'line'; // Income
                            data.datasets[1].type = 'bar';  // Expenses
                        }
                        const ctx = mainChart.getContext('2d');
                        window.mainChartInstance = new Chart(ctx, {
                            data: data,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true },
                                },
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    } else {
                        mainChart.parentNode.innerHTML = 
                            '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">No data to display</div>';
                    }
                });
        } else {
            mainChartTitle.textContent = 'Monthly Income & Spending';
            // Monthly income & spending (bar/line chart)
            fetch(`/get_chart_data?type=monthly_trend${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.labels && data.labels.length > 0) {
                        const ctx = mainChart.getContext('2d');
                        window.mainChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: data,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { display: true },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: { display: true, text: 'Amount' }
                                    }
                                }
                            }
                        });
                    } else {
                        mainChart.parentNode.innerHTML = 
                            '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">No monthly data available</div>';
                    }
                });
        }
        // Category Pie Chart (always shown)
        fetch(`/get_chart_data?type=category${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.labels && data.labels.length > 0) {
                const ctx = document.getElementById('categoryChart').getContext('2d');
                    window.categoryChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                position: 'right',
                                    labels: { font: { size: 11 }, boxWidth: 15 }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        let value = context.parsed || 0;
                                        let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        let percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('categoryChart').parentNode.innerHTML = 
                    '<div style="height: 100%; display: flex; align-items: center; justify-content: center; color: #666;">No expense data to display</div>';
            }
        });
        // Fetch summary (income, expense, balance)
        fetch(`/get_summary?${params.substring(1)}`)
            .then(response => response.json())
            .then(summary => {
                const section = document.getElementById('summary-section');
                section.innerHTML = `
                    <div>
                        <h3 style="margin-bottom: 0.5rem;">Summary</h3>
                        <div style="display: flex; gap: 2rem;">
                            <div>Income:<br><strong style="color: #166534; font-size: 3em; font-weight: 500;">${summary.total_income.toFixed(2)}</strong></div>
                            <div>Expenses:<br><strong style="color: #b91c1c; font-size: 3em; font-weight: 500;">${summary.total_expense.toFixed(2)}</strong></div>
                            <div>Balance:<br><strong style="font-size: 3em; font-weight: 500;">${summary.balance.toFixed(2)}</strong></div>
                        </div>
                    </div>`;
            });
        // Fetch transactions for the table
        fetch(`/get_transactions?${params.substring(1)}`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('transactions-table-body');
                tbody.innerHTML = '';
                data.forEach(transaction => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${transaction.date || 'N/A'}</td>
                            <td>${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</td>
                            <td class="${transaction.type}">${transaction.amount.toFixed(2)}</td>
                            <td>${transaction.category || ''}</td>
                            <td>${transaction.description || ''}</td>
                            <td style="padding: 0.3rem 0.5rem; text-align: center; vertical-align: middle;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; justify-content: center;">
                                    <button class="edit-transaction-btn" data-id="${transaction.transaction_id}" style="padding: 0.2rem 1.2rem; font-size: 0.9em; min-width: 80px;">Edit</button>
                                    <form action="/delete_transaction/${transaction.transaction_id}" method="POST" style="margin: 0; box-shadow: none; display: inline;">
                                        <button type="submit" class="secondary outline" style="padding: 0.2rem 1.2rem; font-size: 0.9em; min-width: 80px; margin: 0;">Delete</button>
                                    </form>
                                </div>
                            </td>
                        </tr>`;
                });
            });
    }
    // Polish: Dynamically populate month/year dropdowns from backend
    fetch('/get_months_years')
        .then(response => response.json())
        .then(monthsYears => {
            // Clear dropdowns
            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';
            const uniqueYears = [];
            const monthsByYear = {};
            monthsYears.forEach(obj => {
                if (!uniqueYears.includes(obj.year)) uniqueYears.push(obj.year);
                if (!monthsByYear[obj.year]) monthsByYear[obj.year] = [];
                if (!monthsByYear[obj.year].includes(obj.month)) monthsByYear[obj.year].push(obj.month);
            });
            // Populate year dropdown
            uniqueYears.forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            });
            // Populate month dropdown for the most recent year
            let defaultYear = uniqueYears.length > 0 ? uniqueYears[0] : (new Date()).getFullYear();
            let defaultMonth = (monthsByYear[defaultYear] && monthsByYear[defaultYear][0]) || ((new Date()).getMonth() + 1).toString().padStart(2, '0');
            if (monthsByYear[defaultYear]) {
                monthsByYear[defaultYear].forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = new Date(2000, parseInt(m, 10) - 1, 1).toLocaleString('default', { month: 'long' });
                    monthSelect.appendChild(opt);
                });
            } else {
                // fallback: all months
                for (let i = 1; i <= 12; i++) {
                    const m = i.toString().padStart(2, '0');
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = new Date(2000, i - 1, 1).toLocaleString('default', { month: 'long' });
                    monthSelect.appendChild(opt);
                }
            }
            // Set default selected
            yearSelect.value = defaultYear;
            monthSelect.value = defaultMonth;
            selectedYear = defaultYear;
            selectedMonth = defaultMonth;
            setActiveTab('all_time');
            reloadDashboardData();
            // When year changes, update months dropdown
            yearSelect.addEventListener('change', function() {
                const y = yearSelect.value;
                monthSelect.innerHTML = '';
                if (monthsByYear[y]) {
                    monthsByYear[y].forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = new Date(2000, parseInt(m, 10) - 1, 1).toLocaleString('default', { month: 'long' });
                        monthSelect.appendChild(opt);
                    });
                    monthSelect.value = monthsByYear[y][0];
                } else {
                    for (let i = 1; i <= 12; i++) {
                        const m = i.toString().padStart(2, '0');
                        const opt = document.createElement('option');
                        opt.value = m;
                        opt.textContent = new Date(2000, i - 1, 1).toLocaleString('default', { month: 'long' });
                        monthSelect.appendChild(opt);
                    }
                    monthSelect.value = ((new Date()).getMonth() + 1).toString().padStart(2, '0');
                }
                selectedYear = y;
                selectedMonth = monthSelect.value;
                if (mode === 'month') reloadDashboardData();
            });
            monthSelect.addEventListener('change', function() {
                selectedMonth = monthSelect.value;
                if (mode === 'month') reloadDashboardData();
            });
        });
    // Floating Action Button and Modal logic
    const fab = document.getElementById('fab-add-transaction');
    const modal = document.getElementById('add-transaction-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const addTransactionForm = document.getElementById('add-transaction-form');
    function openModal() {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeModal() {
        modal.style.display = 'none';
        document.body.style.overflow = '';
        addTransactionForm.reset();
    }
    fab.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });
    // Modal category field logic
    function updateModalCategoryField() {
        var isIncome = document.getElementById('modal_type_income').checked;
        var categoryInput = document.getElementById('modal_category');
        var label = document.getElementById('modal_category_label');
        if (isIncome) {
            categoryInput.setAttribute('list', 'modal_income_categories');
            categoryInput.placeholder = 'e.g., Salary';
            label.textContent = 'Category * (Income)';
        } else {
            categoryInput.setAttribute('list', 'modal_expense_categories');
            categoryInput.placeholder = 'e.g., Groceries';
            label.textContent = 'Category * (Expense)';
        }
    }
    document.getElementById('modal_type_income').addEventListener('change', updateModalCategoryField);
    document.getElementById('modal_type_expense').addEventListener('change', updateModalCategoryField);
    updateModalCategoryField();
    // AJAX submit for add transaction
    addTransactionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(addTransactionForm);
        fetch(addTransactionForm.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                closeModal();
                reloadDashboardData();
                window.location.href = response.url; // Return to dashboard
            } else {
                return response.text();
            }
        })
        .then(data => {
            // Optionally show a toast or error
        });
    });
    // Edit Transaction Modal logic
    const editModal = document.getElementById('edit-transaction-modal');
    const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
    const editTransactionForm = document.getElementById('edit-transaction-form');
    function openEditModal() {
        editModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeEditModal() {
        editModal.style.display = 'none';
        document.body.style.overflow = '';
        editTransactionForm.reset();
    }
    closeEditModalBtn.addEventListener('click', closeEditModal);
    editModal.addEventListener('click', function(e) {
        if (e.target === editModal) closeEditModal();
    });
    // Attach event to edit buttons
    document.body.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-transaction-btn')) {
            const transactionId = e.target.getAttribute('data-id');
            fetch(`/get_transaction/${transactionId}`)
                .then(res => res.json())
                .then(data => {
                    // Populate the form fields
                    editTransactionForm.action = `/edit_transaction/${transactionId}`;
                    editTransactionForm.innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 0.7rem; align-items: flex-start; margin-bottom: 1.2rem;">
                            <label style="margin-bottom: 0.3rem; font-weight: 500;">Type *</label>
                            <div style="display: flex; gap: 1.5rem; align-items: center;">
                                <input type="radio" id="edit_type_income" name="type" value="income" ${data.type === 'income' ? 'checked' : ''} style="margin-bottom: 0;">
                                <label for="edit_type_income" style="margin-bottom: 0; margin-right: 0.5rem;">Income</label>
                                <input type="radio" id="edit_type_expense" name="type" value="expense" ${data.type === 'expense' ? 'checked' : ''} style="margin-bottom: 0;">
                                <label for="edit_type_expense" style="margin-bottom: 0;">Expense</label>
                            </div>
                        </div>
                        <div style="display: flex; gap: 1.5rem; align-items: flex-end; flex-wrap: wrap; margin-bottom: 1.2rem;">
                            <div style="flex: 1 1 140px; min-width: 140px;">
                                <label for="edit_amount">Amount *</label>
                                <input type="number" step="0.01" min="0.01" id="edit_amount" name="amount" value="${data.amount}" required>
                            </div>
                            <div style="flex: 1 1 180px; min-width: 180px;" id="edit_category_field">
                                <label id="edit_category_label" for="edit_category">Category *</label>
                                <input list="edit_income_categories" id="edit_category" name="category" value="${data.category || ''}" placeholder="e.g., Salary">
                                <datalist id="edit_income_categories">
                                    <option value="Salary">
                                    <option value="Bonus">
                                    <option value="Other">
                                </datalist>
                                <datalist id="edit_expense_categories">
                                    {% for cat in categories %}
                                        <option value="{{ cat }}">
                                    {% endfor %}
                                    <option value="Food">
                                    <option value="Utilities">
                                    <option value="Transport">
                                    <option value="Entertainment">
                                    <option value="Shopping">
                                    <option value="Health">
                                    <option value="Other">
                                </datalist>
                            </div>
                            <div style="flex: 2 1 220px; min-width: 220px;">
                                <label for="edit_description">Description</label>
                                <input type="text" id="edit_description" name="description" value="${data.description || ''}">
                            </div>
                            <div style="flex: 1 1 180px; min-width: 180px;">
                                <label for="edit_date">Date</label>
                                <input type="date" id="edit_date" name="date" value="${data.date_for_input || ''}">
                            </div>
                        </div>
                        <button type="submit" style="margin-top: 0.2rem; width: 100%; height: 3rem;">Update Transaction</button>
                    `;
                    // Category field logic
                    function updateEditModalCategoryField() {
                        var isIncome = document.getElementById('edit_type_income').checked;
                        var categoryInput = document.getElementById('edit_category');
                        var label = document.getElementById('edit_category_label');
                        if (isIncome) {
                            categoryInput.setAttribute('list', 'edit_income_categories');
                            categoryInput.placeholder = 'e.g., Salary';
                            label.textContent = 'Category * (Income)';
                        } else {
                            categoryInput.setAttribute('list', 'edit_expense_categories');
                            categoryInput.placeholder = 'e.g., Groceries';
                            label.textContent = 'Category * (Expense)';
                        }
                    }
                    document.getElementById('edit_type_income').addEventListener('change', updateEditModalCategoryField);
                    document.getElementById('edit_type_expense').addEventListener('change', updateEditModalCategoryField);
                    updateEditModalCategoryField();
                    openEditModal();
                });
        }
    });
    // AJAX submit for edit transaction (not nested)
    editTransactionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(editTransactionForm);
        fetch(editTransactionForm.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                closeEditModal();
                reloadDashboardData();
                window.location.href = response.url;
            } else {
                return response.text();
            }
        });
    });
});
</script>
{% endblock %}